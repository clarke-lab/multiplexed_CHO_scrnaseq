---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

# prefiltering library 1
```{r}

cell_library_1 <- readRDS("~/GitHub/multiplexed_CHO_scrnaseq/data/new_rds/cellular_rna_lib1.rds")


cell_library_1[["percent.mt"]] <- PercentageFeatureSet(cell_library_1, features = mito)

cell_library_1 <- RunMiQC(cell_library_1, percent.mt = "percent.mt", nFeature_RNA = "nFeature_RNA", posterior.cutoff = 0.9, 
    model.slot = "flexmix_model")

miqc_plot_1 <- PlotMiQC(cell_library_1, color.by = "miQC.keep")


cell_library_1 <- subset(cell_library_1,
  subset = miQC.keep == "keep")

low_feature_threshold <- median(log10(cell_library_1@meta.data$nFeature_RNA)) - (3*mad(log10(cell_library_1@meta.data$nFeature_RNA)))
high_feature_threshold <- median(log10(cell_library_1@meta.data$nFeature_RNA)) + (3*mad(log10(cell_library_1@meta.data$nFeature_RNA)))
low_count_threshold <- median(log10(cell_library_1@meta.data$nCount_RNA)) - (3*mad(log10(cell_library_1@meta.data$nCount_RNA)))
high_count_threshold <- median(log10(cell_library_1@meta.data$nCount_RNA)) + (3*mad(log10(cell_library_1@meta.data$nCount_RNA)))

cell_1_filter <- cell_library_1@meta.data %>%
  ggplot(aes(x=log10(nCount_RNA), y=log10(nFeature_RNA))) + 
  geom_point(size=0.2) +
  geom_smooth(method="lm") +
  geom_hline(aes(yintercept = low_feature_threshold ), colour = "green", linetype = 2) +
  geom_hline(aes(yintercept = high_feature_threshold), colour = "green", linetype = 2) +
  geom_vline(aes(xintercept = high_count_threshold), colour = "red", linetype = 2) +
  geom_vline(aes(xintercept = low_count_threshold), colour = "red", linetype = 2) +
  theme_bw()

ggMarginal(cell_1_filter, type = "density", fill="lightgrey")

cell_library_1 <- subset(cell_library_1,
    nFeature_RNA >= 10^low_feature_threshold  &
    nFeature_RNA <= 10^high_feature_threshold  &
    nCount_RNA >= 10^low_count_threshold &
    nCount_RNA <= 10^high_count_threshold
)
cell_library_1
```
```{r}
cell_library_2 <- readRDS("~/GitHub/multiplexed_CHO_scrnaseq/data/new_rds/cellular_rna_lib2.rds")


cell_library_2[["percent.mt"]] <- PercentageFeatureSet(cell_library_2, features = mito)
cell_library_2 <- RunMiQC(cell_library_2, percent.mt = "percent.mt", nFeature_RNA = "nFeature_RNA", posterior.cutoff = 0.9, 
    model.slot = "flexmix_model")

PlotMiQC(cell_library_2, color.by = "miQC.keep")

cell_library_2 <- RunMiQC(cell_library_2, percent.mt = "percent.mt", nFeature_RNA = "nFeature_RNA", posterior.cutoff = 0.9, 
    model.slot = "flexmix_model")

cell_library_2 <- subset(cell_library_2,
  subset = miQC.keep == "keep")

low_feature_threshold <- median(log10(cell_library_2@meta.data$nFeature_RNA)) - (3*mad(log10(cell_library_2@meta.data$nFeature_RNA)))
high_feature_threshold <- median(log10(cell_library_2@meta.data$nFeature_RNA)) + (3*mad(log10(cell_library_2@meta.data$nFeature_RNA)))
low_count_threshold <- median(log10(cell_library_2@meta.data$nCount_RNA)) - (3*mad(log10(cell_library_2@meta.data$nCount_RNA)))
high_count_threshold <- median(log10(cell_library_2@meta.data$nCount_RNA)) + (3*mad(log10(cell_library_2@meta.data$nCount_RNA)))

cell_2_filter <- cell_library_2@meta.data %>%
  ggplot(aes(x=log10(nCount_RNA), y=log10(nFeature_RNA))) + 
  geom_point(size=0.2) +
  geom_smooth(method="lm") +
  geom_hline(aes(yintercept = low_feature_threshold ), colour = "green", linetype = 2) +
  geom_hline(aes(yintercept = high_feature_threshold), colour = "green", linetype = 2) +
  geom_vline(aes(xintercept = high_count_threshold), colour = "red", linetype = 2) +
  geom_vline(aes(xintercept = low_count_threshold), colour = "red", linetype = 2) +
  theme_bw()

ggMarginal(cell_2_filter, type = "density", fill="lightgrey")

cell_library_2 <- subset(cell_library_2,
    nFeature_RNA >= 10^low_feature_threshold  &
    nFeature_RNA <= 10^high_feature_threshold  &
    nCount_RNA >= 10^low_count_threshold &
    nCount_RNA <= 10^high_count_threshold
)
cell_library_2
```




Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

